{% extends "layout.html" %} {% block title %}Heats{% endblock %} {% block head %} {% endblock %} {% block content %}
<script type="text/javascript" charset="utf-8">

	//CAAR Ini
	function setCookie(cname, cvalue, exdays) {
	  var d = new Date();
	  d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
	  var expires = "expires="+d.toUTCString();
	  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
	}

	function getCookie(cname) {
	  var name = cname + "=";
	  var ca = document.cookie.split(';');
	  for(var i = 0; i < ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') {
		  c = c.substring(1);
		}
		if (c.indexOf(name) == 0) {
		  return c.substring(name.length, c.length);
		}
	  }
	  return "";
	}

	function checkCookie() {
	  var user = getCookie("username");
	  if (user != "") {
		alert("Welcome again " + user);
	  } else {
		user = prompt("Please enter your name:", "");
		if (user != "" && user != null) {
		  setCookie("username", user, 365);
		}
	  }
	}

	////////////////////////
	
	function exec_checkbox( cid ) {
		//save value
		var cvalue = ( $("#"+cid).prop('checked')?"checked":"unchecked");
		console.log(cid + "  " + cvalue);
		setCookie(cid, cvalue, 1 ) 
		return 0;
	}
    //CAAR end


	$(document).ready(function () {
		socket.emit('load_data', {'load_types': [
			'all_languages',
			'language',
			'frequency_data',
			'class_data',
			'heat_data',
			'pilot_data'
		]});



		//CAAR pull saved values
		var lst_checkboxes = ["checkbox_heat_groups","checkbox_show_locked"];
		for(i in lst_checkboxes){
			var strid = getCookie(lst_checkboxes[i] );
			if(strid) {
				switch (strid) {
					case 'checked':
						$("#"+lst_checkboxes[i]).prop("checked", true);
						break;
					case 'unchecked':
						$("#"+lst_checkboxes[i]).prop("checked", false);
					default:
						console.log('Sorry, we are out of ' + strid + '.');
				}
			}
		}//for



		socket.on('all_languages', function (msg) {
			rotorhazard.language_strings = msg.languages;
		});

		socket.on('language', function (msg) {
			if (msg.language) {
				rotorhazard.interface_language = msg.language;
			}
		});

		socket.on('frequency_data', function (msg) {
			for (var i in msg.frequency) {
				if (typeof(rotorhazard.nodes[i]) === 'undefined') {
					rotorhazard.nodes[i] = new nodeModel();
				}
				rotorhazard.nodes[i].frequency = msg.frequency[i];
				freq.updateBlocks();
			}
		});

		socket.on('pilot_data', function (msg) {
			msg.pilots.sort(function(a, b){
				if (a.name < b.name)
					return -1;
				if (a.name > b.name)
					return 1;
				return 0;
			});

			$(".pilots").empty();
			for (var i in msg.pilots) {
				if (msg.pilots[i]) {
					var el = $('<li data-id="' + msg.pilots[i].pilot_id + '">');
					el.append('<div class="name">'+ msg.pilots[i].name + '</div>');
					el.append('<div class="callsign">' + msg.pilots[i].callsign + '</div>');
					el.appendTo($('.pilots'));
				}
			}
		});




		socket.on('heat_data', function (msg) {
		
		console.log( "HELLO  " + $('#checkbox_heat_groups').prop('checked'));

		
		function add_class( c ) { //receives current class
			
			
			
		///	if (c.name == null){
		//		c.name = 'undefined';
		//	}
		
			if (c.name) {
					var nodeclass = $('<div class="panel collapsing">');
					nodeclass.append('<div class="panel-header"> <h2>'+ c.name + '</h2></div>');
					var groupName = 'caarclassheats_' + c.id ;
					nodeclass.append('<div class="panel-content"><div id="' + groupName + '"> <ol class="heats"> </ol> </div></div></div>');
					//add to tree
					nodeclass.appendTo(bc);
				}
			}

			//CAAR 1 - Add classes
			$("#caarheats").empty();
			var bc = $('<div>');
			for (var i in msg.classes ){
			var c = msg.classes[i];
			    console.log( "Found class: heat_id " +  c.name +   "class_id "+  c.id );
			
				if (c.name) {
					add_class( c )
			//		var nodeclass = $('<div class="panel collapsing">');
			//		nodeclass.append('<div class="panel-header"> <h2>'+ c.name + '</h2></div>');
			//		var groupName = 'caarclassheats_' + c.id ;
			//		nodeclass.append('<div class="panel-content"><div id="' + groupName + '"> <ol class="heats"> </ol> </div></div></div>');
			//		//add to tree
			//		nodeclass.appendTo(bc);
				}
			}
			//add to DOM	
			bc.appendTo($("#caarheats"));

			//add content
			for (var i in msg.heats) {
				var heats = msg.heats[i];
				var el = $('<li>');
				if(heats.locked) {
					el = $('<li style="background-color:lightblue">');
					}
				
				if (heats.note) {
					el.append('<h3>' + heats.note + '</h3>');
				} else {
					el.append('<h3>'+ __('Heat') + ' ' + heats.heat_id + '</h3>');
				}

				var nodelist = $('<ol>');
				var callsign;
				for (j in heats.pilots) {
					var heatpilot = heats.pilots[j];
					var slot = $('<li>');
					slot.append('<div class="channel-block" data-node="' + j + '"><span class="ch"></span> <span class="fr"></span></div>');

					callsign = __('-None-');
					for (var k in msg.pilot_data) {
						if (msg.pilot_data[k].pilot_id == heatpilot) {
							callsign = msg.pilot_data[k].callsign;
							break;
						}
					}

					slot.append('<div class="pilot-name">' + callsign + '</div');
					nodelist.append(slot);
				}
				el.append(nodelist);

				// class indicator
				if (msg.classes.length) {
					if (heats.class_id) {
						for (var i in msg.classes) {
							if (msg.classes[i].id == heats.class_id) {
								el.append('<div class="race_class">' + msg.classes[i].name + '</div>')
								break;
							}
						}
					} else {
						el.append('<div class="race_class">Unclassified</div>');
					}
				}
				
				if (heats.locked) {
					console.log( "locked ; heat_id "+ heats.heat_id +", heat_note " + heats.note + ", class_id " + heats.class_id );  // nodeName
				    //el.firstElementChild.style.backgroundColor = "Red";
				}
				el.appendTo($( '#' + ('caarclassheats_' + heats.class_id) + ' ' + String.fromCharCode(46) + 'heats' ));
			}
			freq.updateBlocks();
		});

		socket.on('class_data', function (msg) {
			$(".race_classes").empty();

			if (msg.classes.length) {

				var classlist = $('<ol>');
				for (var i in msg.classes) {
					var race_class = msg.classes[i];
					var el = $('<li>');

					if (race_class.name) {
						el.append('<h3>' + race_class.name + '</h3>');
					} else {
						el.append('<h3>' + __('Class') + ' ' + race_class.id + '</h3>');
					}

					var class_info = $('<div class="class-info">');

					if (race_class.description) {
						class_info.append('<p>' + race_class.description + '</p>');
					}

					if (race_class.format) {
						for (var i in msg.formats) {
							if (msg.formats[i].id == race_class.format) {
								class_info.append('<p><strong>Format:</strong> ' + msg.formats[i].name + '</p>');
								break;
							}
						}
					} else {
						class_info.append('<p>No format restriction</p>');
					}

					class_info.appendTo(el);

					el.appendTo(classlist);
				}
				classlist.appendTo($('.race_classes'));
			} else {
				$('.race_classes').append('<p class="form-note">' + __('This is a single-class event.') + '</p>');
			}
		});

	});
</script>

<style>
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 47px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
</style>

<main class="page-heats">

<!--Display the classes-->
<h2>{{ __('Classes') }}</h2>
<div id="race_classes" class="race_classes">
	<p class="form-note">{{ __('Loading...') }}</p>
</div>


<!--Display the heats-->
<h2>{{ __('CAAR Heats') }}</h2>
<div>
	<strong>Toggle groups</strong>
	<label class="switch">
		<input type="checkbox" checked id="checkbox_heat_groups" onclick='exec_checkbox("checkbox_heat_groups");'/>
		<span class="slider round"/>
	</label>
	<strong>Toggle Show locked</strong>
	<label class="switch">
		<input type="checkbox" id="checkbox_show_locked" onclick='exec_checkbox("checkbox_show_locked");'/>
		<span class="slider round"/>
	</label>
</div>
<ol id="caarheats">
	<li class="heats">{{ __('Loading...') }}</li>
</ol>


<!--Display the pilots-->
<h2>{{ __('Pilots') }}</h2>
<ul class="pilots">
	<li>{{ __('Loading...') }}</li>
</ul>

</main>
{% endblock %}
