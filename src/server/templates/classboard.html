{% extends "layout.html" %} {% block title %}Heats{% endblock %} {% block head %} {% endblock %} {% block content %}
<script type="text/javascript" charset="utf-8">
	$(document).ready(function () {
		socket.emit('load_data', {'load_types': [
			'all_languages',
			'language',
			'frequency_data',
			'class_data',
			'heat_data',
			'pilot_data'
		]});

		socket.on('all_languages', function (msg) {
			rotorhazard.language_strings = msg.languages;
		});

		socket.on('language', function (msg) {
			if (msg.language) {
				rotorhazard.interface_language = msg.language;
			}
		});

		socket.on('frequency_data', function (msg) {
			for (var i in msg.frequency) {
				if (typeof(rotorhazard.nodes[i]) === 'undefined') {
					rotorhazard.nodes[i] = new nodeModel();
				}
				rotorhazard.nodes[i].frequency = msg.frequency[i];
				freq.updateBlocks();
			}
		});

		socket.on('pilot_data', function (msg) {
			msg.pilots.sort(function(a, b){
				if (a.name < b.name)
					return -1;
				if (a.name > b.name)
					return 1;
				return 0;
			});

			$(".pilots").empty();
			for (var i in msg.pilots) {
				if (msg.pilots[i]) {
					var el = $('<li data-id="' + msg.pilots[i].pilot_id + '">');
					el.append('<div class="name">'+ msg.pilots[i].name + '</div>');
					el.append('<div class="callsign">' + msg.pilots[i].callsign + '</div>');
					el.appendTo($('.pilots'));
				}
			}
		});


		
		socket.on('heat_data', function (msg) {

			//CAAR 1 - Add classes 
			//Clean class/heats sections
			$(".caarheats").empty();
			//rebuild class/heats sections
			var bc = $('<div>');
			for (var i in msg.classes ){
				var classx = msg.classes[i];
				if (classx.name) {
					var nodeclass = $('<div class="panel collapsing">');
					nodeclass.append('<div class="panel-header"> <h2>'+ classx.name + '</h2></div>');
					var className = 'caarclassheats_' + classx.id ;   // (classx.name).replace(/[^a-zA-Z0-9]/g,'_');
						nodeclass.append('<div class="panel-content"><div id="' + className + '"> <ol class="heats"> </ol> </div></div></div>');
					//add to tree
					nodeclass.appendTo(bc);
				}
			}
			//add to DOM
			bc.appendTo($(".caarheats"));
		
			
           //CAAR 2 - Add content.
		   //Inicial Seed  
			
        
			for (var i in msg.heats) {
				var heats = msg.heats[i];
				var el = $('<li>');
				if (heats.note) {
					el.append('<h3>' + heats.note + '</h3>');
				} else {
					el.append('<h3>'+ __('Heat') + ' ' + heats.heat_id + '</h3>');
				}

				var nodelist = $('<ol>');
				var callsign;
				for (j in heats.pilots) {
					var heatpilot = heats.pilots[j];
					var slot = $('<li>');
					slot.append('<div class="channel-block" data-node="' + j + '"><span class="ch"></span> <span class="fr"></span></div>');

					callsign = __('-None-');
					for (var k in msg.pilot_data) {
						if (msg.pilot_data[k].pilot_id == heatpilot) {
							callsign = msg.pilot_data[k].callsign;
							break;
						}
					}

					slot.append('<div class="pilot-name">' + callsign + '</div');
					nodelist.append(slot);
				}
				el.append(nodelist);

				// class indicator
				if (msg.classes.length) {
					if (heats.class_id) {
						for (var i in msg.classes) {
							if (msg.classes[i].id == heats.class_id) {
								el.append('<div class="race_class">' + msg.classes[i].name + '</div>')
								break;
							}
						}
					} else {
						el.append('<div class="race_class">Unclassified</div>');
					}
				}

				//Add to DOM
            			var className = 'caarclassheats_' + heats.class_id;
            			console.log(heats.heat_id +'   '  + heats.class_id);
	    			el.appendTo($( '#' + className + ' ' + String.fromCharCode(46) + 'heats' ));

				
			}
			freq.updateBlocks();
		});


		socket.on('class_data', function (msg) {
			$(".race_classes").empty();

			if (msg.classes.length) {

				var classlist = $('<ol>');
				for (var i in msg.classes) {
					var race_class = msg.classes[i];
					var el = $('<li>');

					if (race_class.name) {
						el.append('<h3>' + race_class.name + '</h3>');
					} else {
						el.append('<h3>' + __('Class') + ' ' + race_class.id + '</h3>');
					}

					var class_info = $('<div class="class-info">');

					if (race_class.description) {
						class_info.append('<p>' + race_class.description + '</p>');
					}

					if (race_class.format) {
						for (var i in msg.formats) {
							if (msg.formats[i].id == race_class.format) {
								class_info.append('<p><strong>Format:</strong> ' + msg.formats[i].name + '</p>');
								break;
							}
						}
					} else {
						class_info.append('<p>No format restriction</p>');
					}

					class_info.appendTo(el);

					el.appendTo(classlist);
				}
				classlist.appendTo($('.race_classes'));
			} else {
				$('.race_classes').append('<p class="form-note">' + __('This is a single-class event.') + '</p>');
			}
			
			//CAAR  proof of concept //
			//Save class info into array
			
			/*Class API		
	        current_class = {}
	        current_class['id'] = race_class.id
	        current_class['Â©'] = race_class.name
	        current_class['description'] = race_class.description
	        current_class['format'] = race_class.format_id
	        current_class['locked'] = True/False
	        */
	        
	        /*
	        $(".caarheats").empty();
			
	        if (msg.classes.length) {
	        	for (var i in msg.classes) {
	        		var race_class = msg.classes[i];
					var el = $('<div class="panel collapsing"> 				\
								<div class="panel-header">   				\
									<h2>' + race_class.name + '</h2>        \
								</div> 										\
									<div class="panel-content">">			\
										<h3>LeaderBoard</h3>				\
									</div>									\
								</div>');
					
					
					el.appendTo('.caarheats');
	        	}
	        	
	        } else {
	        	$('.caarheats').append('<p class="form-note">' + __('This is a single-class event.') + '</p>');
	        }
	        */
	        
			 
	        
	        
		});

	});
</script>

<main class="page-heats">

<!--Display the classes-->
<h2>{{ __('Classes') }}</h2>
<div id="race_classes" class="race_classes">
	<p class="form-note">{{ __('Loading...') }}</p>
</div>



<!--Display the heats-->
<h2>{{ __('CAAR Heats') }}</h2>
<ol class="caarheats">
   <li class="heats">{{ __('Loading...') }}</li>
   <!-- <div>
        <div class="panel collapsing">
            <div class="panel-header">
                <h2>Round Q1</h2>
            </div>
            <div class="panel-content">
                <div class="caarheats_Round_Q1">
                    <ol class="heats">
                        <li>
                            <h3>Heat 1</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 1</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 2</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 3</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 4</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q1</div>
                        </li>
                        <li>
                            <h3>Heat 2</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 5</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 6</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 7</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 8</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q1</div>
                        </li>
                        <li>
                            <h3>Heat 3</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 6</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 7</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 8</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 9</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q1</div>
                        </li>
                        <li>
                            <h3>Heat 4</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 9</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 10</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 11</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 12</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q1</div>
                        </li>
                    </ol>
                </div>
            </div>
        </div>            
        <div class="panel collapsing"> 
            <div class="panel-header">
                <h2>Round Q2</h2>
            </div>   
            <div class="panel-content">
                <div class="caarheats_Round_Q2"> 
                    <ol class="heats">
                        <li>
                            <h3>Heat 5</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 1</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 2</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 3</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 4</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q2</div>
                        </li>
                        <li>
                            <h3>Heat 6</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 5</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 6</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 7</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 8</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q2</div>
                        </li>
                        <li>
                            <h3>Heat 7</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 6</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 7</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 8</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 9</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q2</div>
                        </li>
                        <li>
                            <h3>Heat 8</h3>
                            <ol>
                                <li>
                                    <div class="channel-block" data-node="0">
                                        <span class="ch">R1</span>
                                        <span class="fr">5658</span>
                                    </div>
                                    <div class="pilot-name">Callsign 9</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="1">
                                        <span class="ch">R2</span>
                                        <span class="fr">5695</span>
                                    </div>
                                    <div class="pilot-name">Callsign 10</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="2">
                                        <span class="ch">R3</span>
                                        <span class="fr">5732</span>
                                    </div>
                                    <div class="pilot-name">Callsign 11</div>
                                </li>
                                <li>
                                    <div class="channel-block" data-node="3">
                                        <span class="ch">R4</span>
                                        <span class="fr">5769</span>
                                    </div>
                                    <div class="pilot-name">Callsign 12</div>
                                </li>
                            </ol>
                            <div class="race_class">Round Q2</div>
                        </li>
                    </ol>
                </div>      
            </div>
        </div>
    </div> -->
</ol>



<!--Display the pilots-->
<h2>{{ __('Pilots') }}</h2>
<ul class="pilots">
	<li>{{ __('Loading...') }}</li>
</ul>

</main>
{% endblock %}
